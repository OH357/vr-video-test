<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VR 360 – iPhone Step-by-Step</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,Segoe UI,Arial,sans-serif}
    a-scene{width:100%;height:100%}
    #ui{position:absolute;z-index:10;left:12px;right:12px;top:12px;color:#fff}
    #log{white-space:pre-wrap;font-size:12px;opacity:.9;margin-top:8px;background:rgba(0,0,0,.35);padding:8px;border-radius:8px}
    #row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#ff5500;color:#fff;cursor:pointer}
    video{width:100%;max-height:36vh;background:#000;border-radius:8px}
    .hint{opacity:.8;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <div id="ui">
    <div><b>Step 1:</b> Tap ▶️ on the video. When it’s playing, click <b>Use in 360</b>, then <b>Enter VR</b>.</div>
    <video id="vid" controls playsinline webkit-playsinline muted preload="metadata">
      <!-- SAME-ORIGIN FILE next to this index.html -->
      <source src="./video.mp4" type="video/mp4">
    </video>
    <div id="row">
      <button id="bind" disabled>Use in 360</button>
      <button id="enterVR" disabled>Enter VR</button>
    </div>
    <div class="hint">iPhone: Settings → Safari → <b>Motion & Orientation Access</b> = ON.</div>
    <div id="log"></div>
  </div>

  <a-scene id="scene" renderer="antialias:true; xrCompatible:true" loading-screen="enabled:false" vr-mode-ui="enabled:true">
    <a-entity camera look-controls="magicWindowTrackingEnabled:true"></a-entity>
    <a-videosphere id="sphere" rotation="0 -90 0"></a-videosphere>
  </a-scene>

  <script>
    const scene  = document.getElementById('scene');
    const sphere = document.getElementById('sphere');
    const vid    = document.getElementById('vid');
    const bindBt = document.getElementById('bind');
    const vrBt   = document.getElementById('enterVR');
    const logEl  = document.getElementById('log');

    function log(...a){ console.log(...a); logEl.textContent += a.join(' ') + '\n'; }

    // Diagnostics
    vid.addEventListener('loadedmetadata', () => log('loadedmetadata:', vid.videoWidth+'x'+vid.videoHeight));
    vid.addEventListener('canplay',        () => log('canplay'));
    vid.addEventListener('playing',        () => { log('playing'); bindBt.disabled = false; });
    vid.addEventListener('pause',          () => log('pause'));
    vid.addEventListener('error',          () => log('video error code:', (vid.error && vid.error.code) || 'unknown'));

    async function motionPerm(){
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        try { await DeviceMotionEvent.requestPermission(); log('Motion permission granted'); }
        catch(e){ log('Motion permission denied'); }
      }
    }

    bindBt.addEventListener('click', () => {
      try {
        // IMPORTANT: bind the SAME <video> element to avoid autoplay/CORS issues
        sphere.setAttribute('material', { shader: 'flat', src: '#vid' });
        vrBt.disabled = false;
        log('Bound video to 360 sphere. If sphere stays black: same-origin/CORS problem or unsupported codec.');
      } catch(e) {
        log('Bind error:', e);
      }
    });

    vrBt.addEventListener('click', async () => {
      await motionPerm();
      // Make sure it’s playing (user gesture already happened when you tapped ▶️)
      try { await vid.play(); } catch(e){}
      try {
        await scene.enterVR();         // split-screen/Cardboard on iOS
        log('Requested enterVR');
      } catch (e) {
        log('enterVR error, falling back to fullscreen');
        const fs = scene.requestFullscreen || scene.webkitRequestFullscreen || scene.msRequestFullscreen;
        try { fs && fs.call(scene); } catch(_) {}
      }
    });
  </script>
</body>
</html>