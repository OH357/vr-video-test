<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VR 360 â€“ Auto Cardboard (Dropbox)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000}
    canvas{display:block;width:100vw;height:100vh}
    #overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      color:#fff;background:rgba(0,0,0,.85);font:600 18px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing:.2px;z-index:10;text-align:center;padding:24px
    }
    #divider{position:fixed;z-index:5;top:0;bottom:0;left:50%;width:2px;background:rgba(255,255,255,.25);pointer-events:none;display:none}
  </style>
</head>
<body>
  <div id="overlay">Tap to start 360 VR</div>
  <div id="divider"></div>

  <!-- Hidden video; we texture it onto a sphere -->
  <video id="video" muted playsinline webkit-playsinline preload="metadata" style="display:none"></video>

  <!-- Three.js + device orientation control -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/DeviceOrientationControls.js"></script>

  <script>
    // Your Dropbox direct link (raw endpoint)
    const VIDEO_URL = 'https://dl.dropboxusercontent.com/scl/fi/qk3mypjauxppashndes61/vr_360_video.mp4?rlkey=4ycqo8efz90kffgbnylf748ur&st=29yzz4lo&raw=1';

    const vid = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const divider = document.getElementById('divider');

    let renderer, scene, camera, controls, mesh, texture, split = false, running = false;

    // Scene
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, preserveDrawingBuffer:false });
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    document.body.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
    camera.position.set(0,0,0.1);
    controls = new THREE.DeviceOrientationControls(camera);

    // Inverted 360 sphere
    const geo = new THREE.SphereGeometry(500, 64, 64);
    geo.scale(-1, 1, 1);

    function resize(){
      const w = window.innerWidth, h = window.innerHeight;
      renderer.setSize(w, h, false);
      camera.aspect = split ? (0.5 * w / h) : (w / h);
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize);

    function enterFullscreen(el){
      const fs = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      try { fs && fs.call(el); } catch(e){}
    }

    async function ensureMotionPermission(){
      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        try { await DeviceMotionEvent.requestPermission(); } catch(e){}
      }
    }

    function animate(){
      if (!running) return;
      requestAnimationFrame(animate);
      controls.update();

      if (split){
        const w = renderer.domElement.width, h = renderer.domElement.height;
        renderer.setScissorTest(true);

        // Left eye (mono)
        renderer.setViewport(0, 0, w/2, h);
        renderer.setScissor(0, 0, w/2, h);
        renderer.render(scene, camera);

        // Right eye (same view)
        renderer.setViewport(w/2, 0, w/2, h);
        renderer.setScissor(w/2, 0, w/2, h);
        renderer.render(scene, camera);

        renderer.setScissorTest(false);
      } else {
        renderer.render(scene, camera);
      }
    }

    async function startExperience(){
      overlay.style.display = 'none';

      await ensureMotionPermission();

      // Set src on user gesture then play
      vid.crossOrigin = 'anonymous'; // harmless on same-origin; needed if host allows CORS
      if (vid.src !== VIDEO_URL) vid.src = VIDEO_URL;

      try { await vid.play(); } catch(e){ /* iOS should allow muted */ }

      // Create video texture + mesh
      texture = new THREE.VideoTexture(vid);
      texture.minFilter = THREE.LinearFilter;
      texture.magFilter = THREE.LinearFilter;
      texture.format = THREE.RGBFormat;

      const mat = new THREE.MeshBasicMaterial({ map: texture });
      mesh = new THREE.Mesh(geo, mat);
      scene.add(mesh);

      // Force split-screen Cardboard
      split = true;
      divider.style.display = 'block';
      resize();

      // Go fullscreen for headset
      enterFullscreen(document.documentElement);

      // Run
      if (!running){ running = true; animate(); }
    }

    // First tap anywhere starts everything (no buttons)
    const firstInteract = () => {
      window.removeEventListener('touchstart', firstInteract, {passive:true});
      window.removeEventListener('pointerdown', firstInteract);
      startExperience();
    };
    window.addEventListener('touchstart', firstInteract, {passive:true});
    window.addEventListener('pointerdown', firstInteract);

    // Basic error logging (open Safari console via Mac for details)
    vid.addEventListener('error', () => console.warn('Video error:', vid.error));
  </script>
</body>
</html>